<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe Aroma - YÃ¶netim Paneli</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 0;
            transition: background-color 0.4s, color 0.4s;
        }

        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #e67e22;
        }

        .login-screen,
        .admin-panel {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 100px auto;
        }

        body.dark-mode .login-screen,
        body.dark-mode .admin-panel {
            background: #1e1e1e;
        }

        input,
        button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        button {
            background: #e67e22;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #d35400;
        }

        .category-section {
            margin-bottom: 60px;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .category-section {
            background: #1e1e1e;
        }

        .item {
            border: 1px solid #eee;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }

        body.dark-mode .item {
            border-color: #444;
        }

        .add-btn {
            background: #27ae60;
            margin-top: 10px;
        }

        .save-btn {
            position: fixed;
            bottom: 30px;
            right: 0px;
            padding: 15px 30px;
            font-size: 18px;
            background: #e67e22;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div id="login-screen" class="login-screen">
        <h1>YÃ¶netim Paneli</h1>
        <input type="password" id="password" placeholder="Åžifreyi girin">
        <button onclick="checkPassword()">GiriÅŸ Yap</button>
        <p id="error" style="color:red; display:none;">YanlÄ±ÅŸ ÅŸifre!</p>
    </div>

    <div id="admin-panel" class="admin-panel" style="display:none;">
        <div class="container">
            <h1>Cafe Aroma MenÃ¼ YÃ¶netimi</h1>
            <p>TÃ¼m deÄŸiÅŸiklikleri yaptÄ±ktan sonra saÄŸ alttaki <strong>KAYDET</strong> butonuna basÄ±n.</p>

            <div id="categories-container"></div>

            <button class="save-btn" onclick="saveMenu()">ðŸ’¾ KAYDET</button>
        </div>
    </div>

    <script>
        const IMGBB_API_KEY = "9879c053850fc48a7a3d51d3cd4b8199"; // ImgBB API key'in
        const PASSWORD = "123"; // <--- BURAYI DEÄžÄ°ÅžTÄ°R! MÃ¼ÅŸteriye vereceÄŸin ÅŸifre bu olacak

        let menuData = {};

        function checkPassword() {
            const input = document.getElementById('password').value;
            if (input === PASSWORD) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadMenu();
            } else {
                document.getElementById('error').style.display = 'block';
            }
        }

        function loadMenu() {
            fetch('menu.json?v=' + new Date().getTime())  // <--- Cache'i atlat
                .then(r => r.json())
                .then(data => {
                    menuData = data;
                    renderCategories();
                })
                .catch(err => {
                    alert('menu.json yÃ¼klenemedi. SayfayÄ± yenileyin.');
                    console.error(err);
                });

        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';

            Object.keys(menuData.categories).forEach(catKey => {
                const cat = menuData.categories[catKey];
                const div = document.createElement('div');
                div.className = 'category-section';
                div.innerHTML = `
                    <h2>${cat.title}</h2>
                    <input type="text" value="${cat.description}" onchange="menuData.categories['${catKey}'].description = this.value">
                    <label>Hero Light FotoÄŸraf:</label>
                    <input type="text" value="${cat.heroLight}" onchange="menuData.categories['${catKey}'].heroLight = this.value">
                    <label>Hero Dark FotoÄŸraf:</label>
                    <input type="text" value="${cat.heroDark}" onchange="menuData.categories['${catKey}'].heroDark = this.value">
                    <h3>ÃœrÃ¼nler</h3>
                    <div id="items-${catKey}"></div>
                    <button class="add-btn" onclick="addItem('${catKey}')">+ Yeni ÃœrÃ¼n Ekle</button>
                `;
                container.appendChild(div);

                const itemsDiv = document.getElementById(`items-${catKey}`);
                cat.items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <h4>ÃœrÃ¼n ${index + 1}</h4>
    <label>Ä°sim:</label>
    <input type="text" value="${item.name}" onchange="menuData.categories['${catKey}'].items[${index}'].name = this.value">
    <label>AÃ§Ä±klama:</label>
    <input type="text" value="${item.description}" onchange="menuData.categories['${catKey}'].items[${index}'].description = this.value">
    <label>Fiyat (TL):</label>
    <input type="number" value="${item.price}" onchange="menuData.categories['${catKey}'].items[${index}'].price = Number(this.value)">

    <label>Light FotoÄŸraf URL:</label>
    <div style="display:flex; gap:10px; align-items:center;">
        <input type="text" value="${item.lightImage}" onchange="menuData.categories['${catKey}'].items[${index}'].lightImage = this.value" style="flex:1;">
        <input type="file" id="light-file-${catKey}-${index}" accept="image/*">
        <button onclick="uploadImage(document.getElementById('light-file-${catKey}-${index}'), this.previousElementSibling.previousElementSibling, 'Light')">YÃ¼kle</button>
    </div>

    <label>Dark FotoÄŸraf URL:</label>
    <div style="display:flex; gap:10px; align-items:center;">
        <input type="text" value="${item.darkImage}" onchange="menuData.categories['${catKey}'].items[${index}'].darkImage = this.value" style="flex:1;">
        <input type="file" id="dark-file-${catKey}-${index}" accept="image/*">
        <button onclick="uploadImage(document.getElementById('dark-file-${catKey}-${index}'), this.previousElementSibling.previousElementSibling, 'Dark')">YÃ¼kle</button>
    </div>

    <button style="background:red; color:white; margin-top:10px;" onclick="deleteItem('${catKey}', ${index})">Bu ÃœrÃ¼nÃ¼ Sil</button>
    <hr>
                    `;
                    itemsDiv.appendChild(itemDiv);
                });
            });
        }

        function addItem(catKey) {
            // Yeni Ã¼rÃ¼nÃ¼ boÅŸ alanlarla ekle
            const newItem = {
                name: "Yeni ÃœrÃ¼n",
                description: "AÃ§Ä±klama yazÄ±n",
                price: 0,
                lightImage: "",
                darkImage: ""
            };
            menuData.categories[catKey].items.push(newItem);

            // Paneli yenile (yeni Ã¼rÃ¼n input'larla dolu gelsin)
            renderCategories();

            // Yeni eklenen Ã¼rÃ¼nÃ¼n index'ini bul ve input'lara odaklan (isteÄŸe baÄŸlÄ±, kullanÄ±cÄ± dostu olsun)
            const newIndex = menuData.categories[catKey].items.length - 1;
            setTimeout(() => {
                const nameInput = document.querySelector(`#items-${catKey} .item:last-child input[type="text"]:first-child`);
                if (nameInput) nameInput.focus();
            }, 100);
        }

        function deleteItem(catKey, index) {
            if (confirm("Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinize emin misiniz?")) {
                menuData.categories[catKey].items.splice(index, 1);
                renderCategories();
            }
        }

        async function saveMenu() {
            if (!confirm("DeÄŸiÅŸiklikleri kaydetmek istediÄŸinize emin misiniz?")) return;

            let token = localStorage.getItem('githubToken');
            if (!token) {
                token = prompt("GitHub Personal Access Token'Ä± girin (bir kez girdikten sonra hatÄ±rlanacak):");
                if (!token) return;
                localStorage.setItem('githubToken', token);
            }

            try {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(menuData, null, 2))));

                // HER SEFERÄ°NDE EN GÃœNCEL SHA'YI AL (bu hata iÃ§in kesin Ã§Ã¶zÃ¼m)
                const shaResponse = await fetch('https://api.github.com/repos/ulascorb321/qrmenuadmin/contents/menu.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!shaResponse.ok) {
                    const err = await shaResponse.json();
                    throw new Error(`SHA alÄ±namadÄ±: ${err.message}`);
                }

                const shaData = await shaResponse.json();
                const currentSha = shaData.sha;

                const response = await fetch('https://api.github.com/repos/ulascorb321/qrmenuadmin/contents/menu.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "MenÃ¼ gÃ¼ncellendi - " + new Date().toLocaleString('tr-TR'),
                        content: content,
                        sha: currentSha  // En gÃ¼ncel SHA kullanÄ±lÄ±yor
                    })
                });

                if (response.ok) {
                    alert("âœ… MenÃ¼ baÅŸarÄ±yla kaydedildi! 1-2 dakika iÃ§inde sitede gÃ¶rÃ¼necek.");
                    location.reload(); // Yeni eklenen satÄ±r
                } else {
                    const err = await response.json();
                    alert("Hata: " + err.message);
                    localStorage.removeItem('githubToken');
                }
            } catch (error) {
                alert("Hata: " + error.message);
                localStorage.removeItem('githubToken');
            }
        }

        async function uploadImage(fileInput, urlInput, mode) {
            const file = fileInput.files[0];
            if (!file) {
                alert("LÃ¼tfen bir fotoÄŸraf seÃ§in.");
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    const url = data.data.url;
                    urlInput.value = url; // URL alanÄ±na otomatik yaz
                    alert(`${mode} fotoÄŸraf yÃ¼klendi: ${url}`);
                } else {
                    alert("YÃ¼kleme hatasÄ±: " + data.error.message);
                }
            } catch (err) {
                alert("BaÄŸlantÄ± hatasÄ±: " + err.message);
            }
        }
    </script>
</body>

</html>